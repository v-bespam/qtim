---
date: 2024-09-25
tags:
  - qtim
---
## Нужно откорректировать

В вашем проекте, использующем Strapi, Nest.js и Vue, взаимодействие между компонентами происходит следующим образом:

1. **Контроллер (PageController)**:
   - В контроллере `PageController` определен метод `getPagesForKartaSayta`, который обрабатывает HTTP GET запросы по маршруту `/pages/karta-sayta`.
   - Этот метод вызывает сервис `PageService`, чтобы получить страницы для определенного типа (в данном случае `SitemapTypeEnum.KARTA_SAYTA`).

2. **Сервис (PageService)**:
   - В методе `getPagesFor` сервиса `PageService` происходит основная логика получения страниц.
   - Сначала формируется ключ для кэша Redis (`redisKey`), который будет использоваться для хранения и извлечения данных.
   - Метод пытается получить данные страниц из Redis с помощью `this.redisService.get(redisKey)`. Если данные не найдены (т.е. `pages` равно `null` или `undefined`), происходит извлечение данных из Strapi.

3. **Получение данных**:
   - Для получения страниц из Strapi используется метод `this.strapiService.get`, который делает запрос к API Strapi для получения всех страниц с определенными параметрами (например, без ограничения по количеству и сортировке по URL).
   - Параллельно вызывается метод `this.getCustomPagesFor(type)`, который, вероятно, возвращает кастомные страницы, специфичные для данного типа.

4. **Обработка данных**:
   - После получения данных из Strapi и кастомных страниц, они объединяются в один массив `allPages`.
   - Затем происходит фильтрация страниц: исключаются страницы, которые имеют мета-теги `excludeFromSitemap` или `canonical`.
   - Для оставшихся страниц формируется объект с необходимыми полями (id, url, title, updatedAt, sitemapConfig). Заголовок страницы (`title`) формируется на основе мета-данных или содержимого блока `banner-block`.

5. **Кэширование**:
   - После обработки и формирования списка страниц, результат сохраняется в Redis с помощью `this.redisService.set(redisKey, pages)`, чтобы в будущем можно было быстро извлекать данные без повторных запросов к Strapi.

6. **Возврат данных**:
   - В конце метод `getPagesFor` возвращает массив страниц, который затем будет отправлен клиенту в ответ на HTTP запрос.

Таким образом, взаимодействие между компонентами происходит через контроллер, который вызывает сервис для получения данных, а сервис использует кэш Redis для оптимизации производительности, извлекая данные из базы данных только в случае необходимости.