---
date: 2024-09-25
tags:
  - qtim
---
Есть два бэка на Nest.JS - один для dev, другой для prod окружения, но при этом используется один экземпляр Strapi, который позволяет управлять структурой сайта как для dev, так и для prod.

При внесении изменений на Strapi, обновления применяются сразу к обоим окружениям, но чтобы они отобразились необходимо очистить кэш, который хранится в Redis. Сделать это можно отправив запрос GET к Nest.JS по адресу `nest/api/cache/clear`.

Если запрос очистки кэша отправляется в dev окружении (https://dev.onlineschool-1.ru/), то обновляется только оно. Как только изменения будут протестированы и готовы к отправке в prod, необходимо сбросить кэш в Redis для prod окружения (https://onlineschool-1.ru/), отправив аналогичный запрос.

При необходимости внесения изменений в бэк Nest.JS, сначала данные обновляются в dev окружении Nest, затем, если все хорошо, изменения переносятся в prod Nest. После этого можно очистить кэш Redis в dev окружении, проверить как все работает, и затем уже сбросить кэш prod, чтобы изменения вступили в силу.

Методы в Nest.JS сперва обращаются к кэшу для поиска данных, если их там нет, тогда запрос направляется к Strapi.

Выходные данные на запросы настраиваются в Strapi.

Для работы с вакансиями используется отдельный поддомен - https://team.onlineschool-1.ru/

## Nest.JS CacheController

Очищает кэш Redis

| Метод | URL                    | Описание           |
| ----- | ---------------------- | ------------------ |
| GET   | `nest/api/cache/clear` | Очистить кэш Redis |

При отправке запроса сначала вызывается `this.redisService.reset()`, который очищает весь кэш при помощи `RedisService`. Затем вызывается `this.searchService.createIndex()`, который пересоздает индекс Elasticsearch для поиска. В конце метод возвращает `true`.

Дополнительно, `RedisService` поддерживает следующие методы:

- `get<T>(key: string)`: позволяет получить значение из кэша по ключу
- `set<T>(key: string, value: T, ttl?: number)`: позволяет устанавить значение в кэше для указанного ключа с определенным временем жизни
- `del(key: string)`: позволяет удалить значение из кэша по ключу
- `reset()`: очищает весь кэш

При создании индекса Elasticsearch выполняются следующие операции:

1. Сначала проверяется, существует ли индекс. Если он существует, то он удаляется.
2. В массив, при помощи Strapi собираются данные для индексации в Elasticsearch (страницы, курсы, новости, учителя). Strapi выполняет подготовку данных и кеширует их в Redis.
3. Создается массив операций для индексации, где каждая операция включает в себя индексирование документа.
4. Создание индекса
5. Индексация данных
6. В конце выводится информация о завершении индексации и предупреждения о возможных ошибках.

На шаге 2 производится обращение к Strapi при помощи метода `get` сервиса `StrapiService`. Дополнительно, `StrapiService` поддерживает следующие методы:

- get
- create
- createWithFiles
- update
- updateWithFiles

