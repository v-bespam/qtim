---
date: 2024-08-14
tags:
  - qtim
---
# Техническое задание подключения оплаты банка Точка проекта Понимаю

## Процесс оплаты, пополнения баланса, возврата средств и отображения на Frontend

### **Процесс** **оплаты консультации пользователем**

1. Пользователь выбирает консультацию, нажимает кнопку оплаты
2. Во время оплаты он может привязать карту, может и не привязывать. Это большой роли не играет. Пользователь может даже просто у себя в личном кабинете, без покупки консультации привязать карту.
3. Если оплата проходит нормально то происходит несколько вещей:
	1. Статус консультации меняется на Оплачен
	2. Консультация попадает в раздел Платежи
	3. У клиента отображаются на балансе деньги, равные сумме списания/консультации
	4. Администраторы сайта должны эту информацию видеть
8. После прохождения консультации происходит следующее:
	1. У пользователя с баланса удаляются деньги
	2. Администратор видит. что консультация успешно состоялась

### Оплата

На первом этапе необходимо уточнить у клиента какого банка его карта - российского или иностранного. В первом случае необходимо идти по пути [[#Процесс оплаты для пользователей из России через банк Точка]], во втором следует продумать принцип работы заранее, потому что банк в Казахстане может быть заменен. Для каждого банка должен быть подготовлен собственный коннектор и конфигурация.

Для разных платежных систем должна быть отдельная конфигурация, отдельный коннектор, в частности для Российской Федерации и Казахстана. Должно быть 2 разных точки, 2 разных аккаунта - 1 точка для России и 1 для Казахстана соответственно. На текущий момент сделан один коннектор для обоих приложений, это необходимо исправить.

Если пользователь заходит с IP из Казахстана, то сперва он должен ответить на вопрос какая у него карта - российского банка или иностранного. Если пользователь выбирает российски банк, то его перенаправляет в банк Точка, где следует обратиться к его API. В противном случае, необходимо обратиться к API другого банка.

В случае, если пользователь при оплате хочет воспользоваться картой российского банка, то у него на странице оплаты должен быть выбор: оплатить картой или через СБП. Необходимо решить как сделать дизайн страницы так, чтобы подталкивать пользователя к оплате через СБП.

Информацию о том, выполняет ли фискализацию на своей стороне банк Точка предоставляет клиент. Список товаров или услуг, их наименование также передает клиент.

Имя указывается нами. Налоговую ставку, скорее всего, будем указывать самостоятельно - будет отображаться сообщение о том, что НДС уже включен в стоимость заказа, которая была передана банку Точка.

### Привязка карты

В случае, если клиент хочет записаться на **платную** консультацию, ему необходимо предложить привязать банковскую карту. Если клиент соглашается, то необходимо списать у него с карты небольшую сумму, например 2 рубля, для подтверждения корректности реквизитов карты. В случае успешной оплаты, следует сразу же вернуть деньги и привязать карту к пользователю для следующей оплаты.

Все последующие операции оплаты консультаций производятся с привязанной карты клиента. Данные самой карты, для оплаты, возврата или отвязывания, хранятся в банке, она будет выбираться по ID банка Точка.

Для интеграции с банком используются два идентификатора: ID операции и ID карты.

Будет использоваться два банка, в перспективе - больше, поэтому потребуется сделать два коннектора, по одному на каждый банк.

### Баланс пользователя

Баланс пользователя должен быть виртуальным, он необходим только для возврата средств. Для пользователя он представляет собой некоторую сумму на сайте, которую тот перевел и зарезервировал для будущих консультаций, на которые он записан. Нам эти деньги должны быть видны.

На сайте должна быть реализована не оплата товаров, а пополнение баланса, с которого затем будут списываться средства за консультации. Для администраторов это должно выглядеть так, но пока можно считать, что это оплата товаров.

### Возврат средств

Следует реализовать функционал возврата пользователем собственных средств. Можно вернуть средства только при отмене покупки (в данном случае, это консультация).

> **Важно!** Консультация должна быть отменена, чтобы за нее можно было вернуть деньги.
> Пользователю необходимо сперва отменить консультацию, чтобы затем Администратор мог оформить возврат, либо сам Администратор должен сперва отменить консультацию, а уже затем вернуть деньги.

Если по какой-то причине консультация не состоялась и ее срок закончился, то она должна быть просто завершена. Деньги за нее не возвращаются и списываются с баланса пользователя. Однако, функционал возврата средств при помощи Администратора все равно потребуется, должна быть возможность вернуть деньги.

Должна присутствовать возможность возвращать средства за отмененные консультации, консультации, которые уже состоялись или состоялись не успешно.

Возврат средств за запланированные, но не отмененные консультации или открытые консультации (проходят в настоящий момент) не должен быть предусмотрен.

На данный момент можно считать, что пользователь не сможет вернуть деньги самостоятельно. За него это делает администратор.

Помимо разграничения доступов администраторов (матриц доступов), должна быть возможность предоставить этот функционал непосредственно пользователю.

### Frontend управления платежами

Необходимо будет реализовать собственный Frontend для управления платежам, возвратами и балансами пользователей.

Должен быть раздел **Платежи**. Пользователи с ролью Администратор и Супер-администратор для доступа к разделу должны дополнительно проходить авторизацию через Яндекс, но в настоящее время, все администраторы сайта должны иметь в него доступ.

В интерфейсе должны присутствовать списки пользователей, консультации и денежные средства.

Поиск консультаций осуществляется в разделе **Консультации**, где к каждому элементу списка должен быть добавлен статус - **Оплачено** или **Не оплачено**. В разделе **Платежи** должны отображаться только оплаченные консультации.

В разделе **Платежи** должны отражаться следующие поля: Пользователь, Деньги, Статус консультации, Поиск и кнопка Вернуть деньги.

## Процесс оплаты для пользователей из России через банк Точка

1. Предоставить выбор: Оплата по карте или через СБП. Необходимо подтолкнуть к оплате через СБП
2. Уточнить кто выдаёт чек - партнёр или мы
3. Выпустить JWT токен в интернет банке. При создании первого токена необходимо или указать срок его действия, или указать, что он выдан бессрочно
4. Выбрать разрешения:
	- Просмотр реквизитов
	- Работа с ситемой быстрых платежей
	- Создание ссылки на оплату картой и через СБП (лучше будет выбрать сразу оба, для оформления возврата средств)
	- Создание и получение веб хуков. При создании необходимо выбрать одного из нескольких партнеров

### Список доступных партнеров

Получение списка доступных партнеров описано в [документации](https://enter.tochka.com/doc/v2/redoc/tag/Rabota-s-klientami#get_customers_list_open_banking__apiVersion__customers_get) банка Точка:

1. Необходимо вызвать метод GetCustomerList(), передать в `Header` JWT токен
2. В ответ будет получен массив объектов `Customer` с полями `customerCode` и `customerType`
3. `customerType` может принимать значения `Personal` или `Business`. Для нас важен только тип `Business`

Пример ответа:

```json
{
  "Data": {
    "Customer": [
      {
        "customerCode": "300000092",
        "customerType": "Personal",
        "isResident": true,
        "taxCode": "660000000000",
        "shortName": "ИП Тест",
        "fullName": "Индивидуальный Предприниматель Тест",
        "kpp": "668501001",
        "customerOgrn": "319665800211661"
      }
    ]
  },
  "Links": { ... },
  "Meta": { ... }
}
```

### Работа с платежными ссылками

Метод для создания ссылки на оплату Create Payment Operation With Receipt описан в [документации](https://enter.tochka.com/doc/v2/redoc/tag/Rabota-s-platyozhnymi-ssylkami#create_payment_operation_with_receipt_acquiring__apiVersion__payments_with_receipt_post) банка Точка. Здесь, в теле запроса важны следующие параметры:

- `customerCode` - код партнера, полученный на прошлом шаге для типа Business
- `paymentMode` - способ оплаты, `card` для оплаты картой и `sbp` для СБП (могут быть указаны сразу оба значения)
- `saveCard: true` - вывести предложение пользователю сохранить карту для последующей оплаты. Если в ответе будет возвращен `consumerId`, значит карта для оплаты была сохранена, необходимо сохранить этот ID в базу данных и отправлять его при выполнении следующих платежей
- `merchantId` - Идентификатор торговой точки в интернет-эквайринге. Чтобы его получить необходимо воспользоваться методом GetRetailers() - [документация](https://enter.tochka.com/doc/v2/redoc/tag/Rabota-s-platyozhnymi-ssylkami#get_retailers_acquiring__apiVersion__retailers_get) банка Точка. Также этот метод нужно вызывать для уточнения работы эквайринга
- Объект `Client`:
	- `name` - имя клиента
	- `email` - адрес электронной почты
	- `phone` - телефон для отправки СМС с ссылкой на чек из налоговой
- Массив объектов `Items` (список товаров в заказе):
	- `vatType` - ставка НДС
	- `name` - наименование товара или услуги
	- `amount` - цена за единицу товара (не вся сумма платежа, а цена за одну штуку)
	- `quantity` - количество товара
	- `paymentMethod` - тип оплаты (полная или предоплата)
	- `paymentObject` - тип расчета (товары, услуги, работы)
	-  `measure` - единица измерения (по умолчанию - штуки)

В ответ на запрос будет возвращена ссылка на оплату `paymentLink` и детали платежа. Следует сохранить `operationId` для того чтобы иметь возможность в дальнейшем оформить возврат.

### Работа с веб хуками

После выпуска JWT токена, в ответ будет получен `clientID` - это условный логин приложения, его будет необходимо передать при помощи параметра `path`.

В теле запроса необходимо передать:

- `webhooksList` (список событий, на которое подписано приложение) - следует указать `acquiringInternetPayment`
- `url` -  URL с портом 443 на который необходимо отправлять вебхуки

Вебхук отправляется методом POST, а JWT токен строкой. Метод шифрования AES-256.

[Документация](https://enter.tochka.com/doc/v2/redoc/tag/Rabota-s-vebhukami) на сайте банка Точка.

### Особенности работы с веб хуками

Если на отправленный вебхук не был получен ответ с кодом HTTP 200, а получен любой другой код, то он будет отправляться повторно в течение 30 раз, с периодичностью в 10 секунд.

При создании или изменении вебхука, для проверки доступности указанного хоста, на указанный url будут отправлены по одному тестовому вебхуку для каждого из событий, на которое вы подписаны. Если в статусе ответа не будет получен код HTTP 200, то вебхук создан или изменен не будет.

Вебхук отправляется с заголовком Content-Type: text/plain.

В ответ на отправку вебхука будет отправлен тестовый вебхук, наш ответ должен быть строго HTTP 200.

Если что-то произойдет у нас на сервере, то нам будут отправляться вебхуки в течение 30 раз, с периодичностью в 10 секунд.

### Возврат средств

Метод для возврата платежа по карте Refund Payment Operation описан в [документации](https://enter.tochka.com/doc/v2/redoc/tag/Rabota-s-platyozhnymi-ssylkami#refund_payment_operation_acquiring__apiVersion__payments__operationId__refund_post) банка Точка.

В теле запроса, в параметре `amount` указывается сумма платежа. При создании, в параметрах `path` указывается `operationId` - идентификатор платежа

### Дополнительно

Необходимо отключить эквайринг через банк клиент.
Протестировать можно в песочнице или на боевом слое.
Релизы и изменения по открытому API будут направлены в СМС.

## Требования к Backend

- Интеграция платежных методов
- Тестирование и донастройка
- Вывод платежей для Администратора с функцией возврата
- Покупка контента (консультации) за пользователя
- Разработка архитектуры под множество банков
- Рефакторинг существующей системы записи на платные консультации

## Необходимые изменения

1. Необходимо сделать отдельный коннектор для каждого приложения и конфигурацию для взаимодействия с каждым банком
2. Реализовать собственный Frontend
3. Пользователи с ролью Администратор и Супер-администратор должны дополнительно проходить авторизацию через Яндекс
4. Должна быть создана матрица доступа Администраторов, с последующей передачей прав пользователям



